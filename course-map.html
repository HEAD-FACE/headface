<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Course-Map | Brain-Food</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* วง + เส้นแนวตั้ง */
    .disc{position:relative}
    .disc:not(:first-child)::before{
      content:''; position:absolute; top:-48px; left:50%; transform:translateX(-50%);
      width:4px; height:48px; background:#cbd5e1;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-100 min-h-screen flex flex-col">

<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 id="title" class="text-lg font-bold text-cyan-700">Course</h1>
  <a href="brain.html"
     class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1 rounded-xl font-semibold">
     เลือกวิชาอื่น
  </a>
</header>

<main class="flex-1 flex flex-col items-center p-6 gap-6" id="wrapper">
  <!-- เติมด้วย JS -->
</main>

<script>
const API  = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const qs   = new URLSearchParams(location.search);
const subj = qs.get('subject');          // ST, MT …

if(!subj) location.href='brain.html';
document.getElementById('title').textContent = `วิชา ${subj}`;

(async()=>{
  try{
    // ① ดึง row ของวิชานี้ทั้งหมด
    const j = await fetch(`${API}?action=listParts&subject=${subj}`)
                     .then(r=>r.json());
    if(j.status!=="success") throw 'err';

    /* ② group ตาม subject_id (ST001, ST002 …) */
    const grouped = {};
    j.rows.forEach(r=>{
      if(!grouped[r.id]) grouped[r.id]=[];
      grouped[r.id].push(r);
    });

    /* ③ render lesson-blocks */
    const wrap = document.getElementById('wrapper');
    Object.keys(grouped).sort().forEach(lessonId=>{
      wrap.insertAdjacentHTML('beforeend',`
        <h2 class="font-semibold text-cyan-800 mt-6 mb-2">บท ${lessonId.slice(-3)}</h2>
        <div class="flex flex-col items-center gap-8">
          ${grouped[lessonId].sort((a,b)=>a.part-b.part).map(p=>`
            <button class="disc bg-white shadow-lg rounded-full w-28 h-28 flex flex-col justify-center items-center
                           hover:scale-105 transition"
                    data-id="${lessonId}" data-part="${p.part}">
              <span class="text-xl font-bold text-cyan-700">${p.part}</span>
              <span class="text-[10px] text-gray-500 px-2 truncate max-w-[80%]">${p.content}</span>
            </button>
          `).join('')}
        </div>
      `);
    });

    /* ④ click –> quiz init */
    wrap.querySelectorAll('.disc').forEach(b=>{
      b.onclick = ()=>{
        const id   = b.dataset.id;
        const part = b.dataset.part;
        location.href = `quiz.html?subject=${subj}&lesson=${id}&part=${part}&mode=init`;
      };
    });

  }catch(e){
    alert('โหลดข้อมูลบทไม่สำเร็จ');
    console.error(e);
  }
})();
</script>
</body>
</html>
