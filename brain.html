<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ── basic ───────────────────────────────────────────── */
.no-scroll::-webkit-scrollbar{display:none}
.no-scroll{scrollbar-width:none;-ms-overflow-style:none}

.bf-plate{display:flex;flex-direction:column;align-items:center;gap:.35rem;cursor:pointer;transition:transform .2s}
.bf-plate:hover{transform:scale(1.08)}
.plate-circle{width:4.5rem;height:4.5rem;border-radius:9999px;
              display:flex;align-items:center;justify-content:center;
              background:linear-gradient(135deg,#38bdf8 0%,#2563eb 100%);
              color:#fff;font-size:.9rem;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.15)}

/* แถบขั้น (bar-step) */
.bar-step{width:3.2rem;height:1.4rem;border-radius:.7rem;
          background:#93c5fd;display:flex;align-items:center;justify-content:center;
          color:#fff;font-size:.8rem;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.12)}
</style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen flex flex-col">

<!---------------- Header ---------------->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food</h1>
  <a href="home.html"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
     กลับหน้าหลัก
  </a>
</header>

<!---------------- SUBJECT BAR ---------------->
<section class="bg-white/70 shadow-inner">
  <div id="subjBar" class="flex gap-4 overflow-x-auto no-scroll px-6 py-3"></div>
</section>

<!---------------- COURSE MAP ---------------->
<main class="flex-1 overflow-auto p-6">
  <div id="mapZone" class="relative mx-auto w-max"></div>
</main>

<!-- modal -->
<div id="modal-root"></div>

<script>
/* ---------- CONFIG ---------- */
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";

const SUBJ_NAMES = {
  ST:"วิทยาศาสตร์", ET:"ภาษาอังกฤษ", TH:"ภาษาไทย", MT:"คณิตศาสตร์",
  SO:"สังคมศึกษา", HE:"สุขศึกษา", PE:"พลศึกษา", HS:"ประวัติศาสตร์",
  CH:"ภาษาจีน", ME:"คณิตสากล", SE:"วิทย์สากล", EN:"ENS",
  SR:"เทคโนโลยี", SW:"วิทยาการคอมฯ", SD:"ออกแบบเว็บไซต์", AA:"การงานอาชีพ"
};

/* ---------- SUBJECT BAR ---------- */
(async()=>{
  const bar=subjBar
  try{
     const j=await fetch(`${API}?action=listSubjects`).then(r=>r.json())
     if(j.status!=="success") throw 0
     bar.innerHTML=j.subjects.map(s=>{
        const name=s.name||SUBJ_NAMES[s.code]||s.code
        return `<button data-code="${s.code}"
                 class="subj-btn whitespace-nowrap px-4 py-2 bg-blue-100 rounded-xl hover:bg-blue-200">
                 ${name}</button>`
     }).join("")
     bar.querySelectorAll(".subj-btn").forEach(btn=>{
        btn.onclick=()=>{
          bar.querySelectorAll(".subj-btn").forEach(b=>b.classList.remove("bg-blue-600","text-white"))
          btn.classList.add("bg-blue-600","text-white")
          loadMap(btn.dataset.code)
        }
     })
     bar.querySelector(".subj-btn")?.click()
  }catch{ bar.innerHTML="<p class='text-red-600'>โหลดวิชาไม่สำเร็จ</p>" }
})()

/* ---------- LOAD & DRAW MAP (แนวดิ่ง) ---------- */
async function loadMap(subj){
  const zone=mapZone
  zone.innerHTML="<p class='text-center text-blue-700'>กำลังโหลด…</p>"
  try{
    const j=await fetch(`${API}?action=listParts&subj=${subj}`).then(r=>r.json())
    if(j.status!=="success"||!j.chapters?.length) throw 0

    /* แปลง rows = [{chap,part,content}] แล้วเรียงตาม chap+part */
    const rows=[]
    j.chapters.sort((a,b)=>a.id.localeCompare(b.id)).forEach(ch=>{
       ch.parts.sort((a,b)=>a.no-b.no).forEach(p=>{
          rows.push({chap:ch.id,part:p.no,content:p.content.join(",")})
       })
    })
    drawVertical(rows,zone)
  }catch{
    zone.innerHTML="<p class='text-center text-red-600'>โหลดข้อมูลบทไม่สำเร็จ</p>"
  }
}

function drawVertical(rows,zone){
  zone.innerHTML=""
  const stepH=140
  rows.forEach((r,i)=>{
     const top=i*stepH
     /* plate */
     zone.insertAdjacentHTML("beforeend",`
       <div class="bf-plate absolute" style="top:${top}px;left:0"
            onclick="goQuiz('${r.chap}',${r.part})">
         <div class="plate-circle">${r.part}</div>
         <span class="text-xs text-blue-900 max-w-[6rem] break-words text-center">${r.content}</span>
       </div>`)

     /* bar-step ใส่เลข part ต่อไป */
     if(i<rows.length-1){
       zone.insertAdjacentHTML("beforeend",`
         <div class="bar-step absolute" style="top:${top+70}px;left:1.3rem">
            ${rows[i+1].part}
         </div>`)
     }
  })
  zone.style.height=`${rows.length*stepH}px`
}

/* ---------- ไปหน้า Quiz ---------- */
function goQuiz(chap,part){
  location.href=`quiz.html?chap=${chap}&part=${part}`
}

/* ---------- Modal helper ---------- */
const modalRoot=document.getElementById("modal-root")
function openModal(html){
  modalRoot.innerHTML=
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[90] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`
  mask.onclick=e=>{if(e.target.id==="mask") closeModal()}
}
function closeModal(){ modalRoot.innerHTML="" }
</script>
</body>
</html>
