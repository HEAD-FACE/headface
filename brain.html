<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brain Food – HEAD FACE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* scrollbar hide for pass track */
    #bf-scroll.no-scrollbar::-webkit-scrollbar { display: none; }
    #bf-scroll.no-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
    /* pop animation */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    .pop {
      animation: pop 0.5s ease-in-out;
    }
    /* confetti */
    .confetti {
      position: absolute;
      width: 6px; height: 6px;
      border-radius: 50%;
      pointer-events: none;
      animation: fall 0.7s ease-out forwards;
    }
    @keyframes fall {
      to {
        transform: translateY(60px) rotate(720deg);
        opacity: 0;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen">

<!-- ───────────── Header ───────────── -->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food (BETA)</h1>
  <a href="home.html"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
     กลับหน้าหลัก
  </a>
</header>

<!-- ───────────── Dashboard ───────────── -->
<section class="max-w-3xl mx-auto mt-6 grid grid-cols-2 gap-4">
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">บทที่เรียน</p>
    <p id="stat-lesson" class="text-2xl font-bold text-blue-700">0</p>
  </div>
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">Quiz ที่ทำ</p>
    <p id="stat-quiz" class="text-2xl font-bold text-blue-700">0</p>
  </div>
</section>

<!-- ───────────── Brain-Food Pass (เพิ่มส่วนนี้) ───────────── -->
<section class="max-w-5xl mx-auto mt-10 px-6">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-bold text-blue-800 text-lg">Brain-Food Pass</h2>
    <p class="text-sm text-gray-600">แต้มของคุณ: <span id="bf-point" class="font-bold">0</span></p>
  </div>

  <div class="relative">
    <button id="bf-left"
            class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/70 hover:bg-white
                   shadow p-1 rounded-full">‹</button>
    <button id="bf-right"
            class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/70 hover:bg-white
                   shadow p-1 rounded-full">›</button>

    <div id="bf-scroll" class="overflow-x-auto no-scrollbar scroll-smooth px-8">
      <div id="bf-track" class="relative flex gap-14 items-center py-4 w-max">
        <div class="absolute left-0 right-0 top-1/2 -translate-y-1/2 h-1 bg-gray-300 rounded-full -z-10"></div>
        <!-- รายการ pass จะใส่ด้วย JS -->
      </div>
    </div>
  </div>
</section>

<!-- ───────────── Set Boxes ───────────── -->
<section class="max-w-4xl mx-auto mt-10 grid md:grid-cols-3 gap-6 px-4">

  <!-- Snack -->
  <div id="box-snack" class="group relative cursor-pointer">
    <div
      class="bg-gradient-to-r from-green-400 to-lime-500 rounded-2xl h-40 flex items-center justify-center shadow-lg
             group-hover:scale-105 transition">
      <span class="text-white text-xl font-bold">Snack Set</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">
      สรุปสั้น + Quiz 5 ข้อ
    </p>
  </div>

  <!-- Full -->
  <div id="box-full" class="group relative cursor-pointer">
    <div
      class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl h-40 flex items-center justify-center shadow-lg
             group-hover:scale-105 transition">
      <span class="text-white text-xl font-bold">Full Meal</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">
      บทเรียนเต็ม + Quiz 15 ข้อ (เฉพาะ MAX)
    </p>

    <div id="lock-full"
         class="absolute inset-0 rounded-2xl bg-white/80 backdrop-blur flex flex-col items-center justify-center
                text-center text-purple-600 font-semibold hidden">
      เฉพาะ MAX
    </div>
  </div>

  <!-- Salad (ยังไม่ได้ทำในขั้นนี้) -->
  <div id="box-salad" class="group relative cursor-pointer">
    <div
      class="bg-gradient-to-r from-teal-400 to-cyan-500 rounded-2xl h-40 flex items-center justify-center shadow-lg
             group-hover:scale-105 transition">
      <span class="text-white text-xl font-bold">Salad Set</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">
      Quiz รวมทุกบท (20 ข้อ)
    </p>

    <div id="lock-salad"
         class="absolute inset-0 rounded-2xl bg-white/80 backdrop-blur flex flex-col items-center justify-center
                text-center text-cyan-700 font-semibold hidden">
      เฉพาะ MAX
    </div>
  </div>
</section>

<!-- Modal root -->
<div id="modal-root"></div>

<script>
/* ---------- CONFIG ---------- */
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";

/* ---------- USER / MAX ---------- */
const user  = JSON.parse(localStorage.getItem("user") || "null");
const isMAX = !!user?.lineId;

/* ---------- DASHBOARD ---------- */
(async()=>{
  if(!user) return;
  try{
    const j = await fetch(`${API}?action=get_brain_stats&no=${user.no}`).then(r=>r.json());
    if(j.status==="success"){
      const [l,q] = j.count.split(" ");
      document.getElementById("stat-lesson").textContent = l;
      document.getElementById("stat-quiz").textContent   = q;
    }
  }catch(e){ console.log("stats error",e); }
})();

/* ---------- MODAL helper ---------- */
function openModal(html){
  document.getElementById("modal-root").innerHTML =
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[80] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div>
     </div>`;
  document.getElementById("mask").onclick = e=>{
    if(e.target.id==="mask") closeModal();
  };
}
function closeModal(){ document.getElementById("modal-root").innerHTML=""; }

/* ------------------------------------------------------------- */
/*                        SNACK  FLOW                            */
/* ------------------------------------------------------------- */
document.getElementById("box-snack").onclick = async ()=>{
  // 1) list subjects
  const j = await fetch(`${API}?action=list_snack_subjects`).then(r=>r.json());
  if(j.status!=="success") return alert("โหลดวิชาไม่สำเร็จ");

  const html = j.subjects.map(s=>`
      <button class="sn-sub bg-blue-100 hover:bg-blue-200 px-4 py-2 rounded-xl m-1"
              data-subj="${s.code}">${s.name}</button>`).join("");
  openModal(`<h3 class="text-lg font-semibold text-blue-800 mb-3">เลือกวิชา (Snack)</h3>${html}`);

  document.querySelectorAll(".sn-sub").forEach(btn=>{
     btn.onclick = ()=> chooseChapter(btn.dataset.subj,"snack");
  });
};

/* ------------------------------------------------------------- */
/*                        FULL  FLOW                             */
/* ------------------------------------------------------------- */
document.getElementById("box-full").onclick = async ()=>{
  if(!isMAX){
    alert("ฟีเจอร์นี้สงวนสำหรับ MAX"); return;
  }
  // ใช้ API เดียวกับ snack ได้เลย
  const j = await fetch(`${API}?action=list_snack_subjects`).then(r=>r.json());
  if(j.status!=="success") return alert("โหลดวิชาไม่สำเร็จ");

  const html = j.subjects.map(s=>`
      <button class="fl-sub bg-indigo-100 hover:bg-indigo-200 px-4 py-2 rounded-xl m-1"
              data-subj="${s.code}">${s.name}</button>`).join("");
  openModal(`<h3 class="text-lg font-semibold text-indigo-800 mb-3">เลือกวิชา (Full Meal)</h3>${html}`);

  document.querySelectorAll(".fl-sub").forEach(btn=>{
     btn.onclick = ()=> chooseChapter(btn.dataset.subj,"full");
  });
};

/* ------------------------------------------------------------- */
/*                เลือกบท (ใช้ได้ทั้งสองโหมด)                  */
/* ------------------------------------------------------------- */
async function chooseChapter(subj,mode){
  const j = await fetch(`${API}?action=list_snack_chapters&subj=${subj}`).then(r=>r.json());
  if(j.status!=="success") return alert("error");

  const html = j.chapters.map(c=>`
      <button class="chap-btn block w-full text-left px-4 py-2 my-1 rounded-xl
                     ${mode==='snack'?'bg-gray-100 hover:bg-gray-200':'bg-purple-100 hover:bg-purple-200'}
                     " data-id="${c.id}">
         ${c.title}
      </button>`).join("");

  openModal(`<h3 class="text-lg font-semibold ${mode==='snack'?'text-blue-800':'text-purple-800'} mb-3">
               เลือกบท – ${subj}
             </h3>${html}`);

  document.querySelectorAll(".chap-btn").forEach(btn=>{
     const id = btn.dataset.id;
     btn.onclick = ()=>{
        if(mode==="snack") location.href = `lesson.html?id=${id}`;
        else               location.href = `full.html?id=${id}`;
     };
  });
}

document.getElementById("box-salad").onclick = () =>{
  location.href = `salad.html`;
};

/* ---------- Brain-Food Pass system ---------- */
const bfPointEl = document.getElementById('bf-point');
const bfTrack   = document.getElementById('bf-track');
const bfScroll  = document.getElementById('bf-scroll');
const bfLeftBtn = document.getElementById('bf-left');
const bfRightBtn= document.getElementById('bf-right');

bfLeftBtn.onclick = () => bfScroll.scrollBy({left: -300, behavior: 'smooth'});
bfRightBtn.onclick= () => bfScroll.scrollBy({left: 300, behavior: 'smooth'});

function animatePop(id){
  const img = bfTrack.querySelector(`img[data-id="${id}"]`);
  if(!img) return;
  img.classList.add('pop');
  setTimeout(() => img.classList.remove('pop'), 500);
  const rect = img.getBoundingClientRect();
  for(let i=0; i<25; i++){
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = rect.left + rect.width/2 + (Math.random()*40-20) + 'px';
    c.style.top  = rect.top + 'px';
    c.style.background = `hsl(${Math.random()*360},80%,60%)`;
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 700);
  }
}

async function loadPass(){
  if(!user) return;
  try {
    const res = await fetch(`${API}?action=list_rewards&no=${user.no}`);
    const j = await res.json();
    if(j.status === 'success'){
      renderPass(j.rewards, j.point);
    }
  } catch(e) { console.log("loadPass error", e); }
}

/* ---------- renderPass (ใหม่) ---------- */
function renderPass(rawRewards, point){
  const track = document.getElementById("bf-track");
  track.innerHTML = "";                    // เคลียร์ของเก่า

  /* 1) เรียงแต้มต่ำ → สูง */
  const rewards = [...rawRewards].sort((a,b)=> Number(a.need)-Number(b.need));

  /* 2) วาด UI */
  rewards.forEach(r => {
    /* 2-1) ตัดสิน state */
    const need    = Number(r.need)||0;
    const myPoint = Number(point)||0;

    let state = r.status;                  // locked | claimed | used
    if(state==="locked" && myPoint >= need) state="claim";

    /* 2-2) กำหนดคลาส/ปุ่ม */
    const cls =
          state==="used"    ? "opacity-30"
        : state==="claim"   ? "hover:scale-105 animate-pulse"
        : state==="claimed" ? "ring-4 ring-green-400"
        :                     "grayscale";

    // ข้อความในปุ่ม
    const btnHtml =
          state==="used"    ? '<span class="inline-block bg-gray-300 text-white px-4 py-1 rounded">ใช้แล้ว</span>'
        : state==="claimed" ? `<button class="btn-use bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded" data-id="${r.id}">ใช้</button>`
        : state==="claim"   ? `<button class="btn-claim bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded" data-id="${r.id}">กดรับ</button>`
        :                     `<span class="inline-block bg-gray-300 text-white px-4 py-1 rounded cursor-not-allowed">รอแต้ม</span>`;

    /* 2-3) element HTML */
    track.insertAdjacentHTML("beforeend",`
      <div class="flex flex-col items-center gap-2 text-center ${cls}">
        <img src="${r.img}" class="w-20 h-20 rounded-full border-2 border-white shadow"
             data-id="${r.id}">
        <span class="text-xs text-gray-600">${need} แต้ม</span>
        ${btnHtml}
      </div>
    `);
  });

  /* 3) ติด event ปุ่ม */
  track.querySelectorAll(".btn-claim").forEach(btn=>{
    btn.onclick = async ()=>{
       if(!confirm("ยืนยันรับรางวัลนี้?")) return;
       btn.disabled = true;
       const id = btn.dataset.id;
       const j = await fetch(`${API}?action=claim_reward&no=${user.no}&id=${id}`).then(r=>r.json()).catch(()=>({status:"error"}));
       if(j.status==="success") loadPass(); else alert("รับรางวัลไม่สำเร็จ");
    };
  });

  track.querySelectorAll(".btn-use").forEach(btn=>{
    btn.onclick = async ()=>{
       if(!confirm("ใช้รางวัลนี้ตอนนี้หรือไม่?")) return;
       btn.disabled = true;
       const id = btn.dataset.id;
       const j = await fetch(`${API}?action=use_reward&no=${user.no}&id=${id}`).then(r=>r.json()).catch(()=>({status:"error"}));
       if(j.status==="success") loadPass(); else alert("ใช้รางวัลไม่สำเร็จ");
    };
  });
}

/* ---------- โหลดข้อมูล (call เมื่อเปิดหน้า หรือหลัง claim/use) ---------- */
async function loadPass(){
  if(!user) return;
  try{
     const j = await fetch(`${API}?action=list_rewards&no=${user.no}`).then(r=>r.json());
     if(j.status==="success"){
        document.getElementById("bf-point").textContent = j.point;  // (หากมี element นี้)
        renderPass(j.rewards, j.point);
     }
  }catch(e){ console.error(e); }
}

loadPass();

</script>
</body>
</html>
