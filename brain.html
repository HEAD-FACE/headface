<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ซ่อน scrollbar */
.no-scroll::-webkit-scrollbar{display:none}
.no-scroll{scrollbar-width:none;-ms-overflow-style:none}

/* จาน / node */
.bf-plate{
  @apply flex flex-col items-center gap-2 cursor-pointer transition transform;
}
.bf-plate:hover{transform:scale(1.08)}
.bf-plate.active .plate-circle{ @apply ring-4 ring-blue-400; }

/* เส้นเชื่อม */
.bf-line{
  @apply absolute left-1/2 -translate-x-1/2 top-[40px] w-px bg-blue-300;
}
/* ขนาดวงกลม */
.plate-circle{
  @apply w-24 h-24 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-lg;
}
</style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen flex flex-col">

<!-- Header -->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food</h1>
  <a href="home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
    กลับหน้าหลัก
  </a>
</header>

<!-- Subject bar -->
<section class="bg-white/70 pt-4 pb-2 shadow-inner">
  <div id="subjBar" class="flex gap-4 overflow-x-auto no-scroll px-6"></div>
</section>

<!-- Course Map -->
<main class="flex-1 overflow-auto p-6">
  <div id="mapZone" class="relative mx-auto max-w-lg"></div>
</main>

<!-- Modal -->
<div id="modal-root"></div>

<script>
/* ---------------- CONFIG ---------------- */
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";

/* ใช้แมปชื่อ (thai) เมื่อตัว API ยังไม่ส่ง name มา */
const SUBJ_NAMES = {
  ST:"วิทยาศาสตร์", ET:"ภาษาอังกฤษ", TH:"ภาษาไทย", MT:"คณิตศาสตร์",
  SO:"สังคม", HE:"สุขศึกษา", PE:"พลศึกษา", HS:"ประวัติศาสตร์",
  CH:"ภาษาจีน", ME:"คณิตสากล", SE:"วิทย์สากล", EN:"ENS",
  SR:"เทคโนโลยี", SW:"วิทยาการคอมฯ", SD:"ออกแบบเว็บไซต์", AA:"การงานอาชีพ"
};

/* ---------------- Subject Bar ---------------- */
(async ()=>{
  const bar = document.getElementById("subjBar");
  try{
     const j = await fetch(`${API}?action=listSubjects`).then(r=>r.json());
     if(j.status!=="success") throw "";
     const subs = j.subjects;                 // [{code,name?},...]
     bar.innerHTML = subs.map(s=>{
        const name = s.name || SUBJ_NAMES[s.code] || s.code;
        return `<button data-code="${s.code}"
                        class="subj-btn whitespace-nowrap px-4 py-2 bg-blue-100 rounded-xl
                               hover:bg-blue-200">${name}</button>`;
     }).join("");
     // bind click
     bar.querySelectorAll(".subj-btn").forEach(btn=>{
        btn.onclick = ()=>{
           bar.querySelectorAll(".subj-btn").forEach(b=>b.classList.remove("bg-blue-600","text-white","active"));
           btn.classList.add("bg-blue-600","text-white","active");
           loadMap(btn.dataset.code);
        };
     });
     /* เลือกตัวแรกอัตโนมัติ */
     bar.querySelector(".subj-btn")?.click();
  }catch(e){ bar.innerHTML="<p class='text-red-600'>โหลดวิชาไม่สำเร็จ</p>"; }
})();

/* ---------------- Load & Render Map ---------------- */
async function loadMap(subj){
  const zone = document.getElementById("mapZone");
  zone.innerHTML = "<p class='text-center text-blue-600'>กำลังโหลดบทเรียน…</p>";
  try{
     const j = await fetch(`${API}?action=listParts&subj=${subj}`).then(r=>r.json());
     if(j.status!=="success" || !j.rows?.length) throw "";
     drawMap(j.rows, zone);
  }catch(e){
     zone.innerHTML = "<p class='text-center text-red-600'>โหลดข้อมูลบทไม่สำเร็จ</p>";
  }
}

/* rws = [{id,part,content},…] */
function drawMap(rows, zone){
  zone.innerHTML = "";
  /* รวมตาม part */
  const parts = {};
  rows.forEach(r=>{
     if(!parts[r.part]) parts[r.part]=[];
     parts[r.part].push(r);
  });
  const sortedParts = Object.keys(parts).sort((a,b)=>a-b);

  sortedParts.forEach((p,i)=>{
      const items = parts[p];
      items.forEach((item,idx)=>{
        // node
        zone.insertAdjacentHTML("beforeend",`
          <div class="bf-plate absolute"
               style="top:${i*160}px; left:${idx*180}px">
            <div class="plate-circle bg-gradient-to-br from-blue-400 to-blue-600">${item.content}</div>
            <span class="text-sm">${item.id}</span>
          </div>
        `);
      });
      // เส้นต่อตัวถัดไป (ถ้าไม่ใช่ part สุดท้าย)
      if(i < sortedParts.length-1){
        zone.insertAdjacentHTML("beforeend",`
          <div class="bf-line" style="top:${i*160 + 120}px; height:40px;"></div>
        `);
      }
  });
  /* กำหนดความสูงให้ mapZone */
  zone.style.height = `${sortedParts.length*160 + 40}px`;
}

/* ---------------- Modal helper (optional future use) ---------------- */
function openModal(html){
  document.getElementById("modal-root").innerHTML =
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[90] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`;
  document.getElementById("mask").onclick = e=>{
    if(e.target.id==="mask") closeModal();
  };
}
function closeModal(){ document.getElementById("modal-root").innerHTML=""; }
</script>
</body>
</html>
