<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* ───── จาน + เส้น ───── */
  .plate-img{width:80px;height:80px;object-fit:contain}
  .part-wrap{position:relative;display:inline-flex;flex-direction:column;align-items:center;margin:0 32px}
  .part-wrap::before{content:"";position:absolute;top:40px;left:-32px;width:32px;height:4px;
                     background:#94a3b8}          /* เส้นเชื่อม */
  .part-wrap:first-child::before{display:none}    /* จานแรกของบทไม่ต้องมีเส้น */

  /* แถบหัวบท */
  .chapter-bar{display:flex;align-items:center;gap:.5rem;
               background:#0284c7;color:#fff;padding:.4rem .8rem;border-radius:9999px;
               font-weight:600;margin:1.5rem 0}
</style>
</head>

<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen">
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food (BETA)</h1>
  <a href="home.html"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
     กลับหน้าหลัก
  </a>
</header>

<!-- เมนูเลือกวิชา -->
<section class="max-w-4xl mx-auto mt-6" id="subjectBox"></section>

<!-- แผนที่บทเรียน -->
<section class="max-w-4xl mx-auto mt-8 px-4">
  <div id="map" class="flex flex-col"></div>
</section>

<!-- modal -->
<div id="modal-root"></div>

<script>
const API  = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const plateSrc = "https://i.postimg.cc/9Q00g2DS/image.png";

/* ---------- modal helper ---------- */
function modal(html){
  document.getElementById("modal-root").innerHTML =
   `<div id="mask" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[90]">
      <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full">${html}</div></div>`;
  mask.onclick = e=>{ if(e.target.id==="mask") modal(""); };
}

/* ---------- 1. โหลดรายวิชา ---------- */
(async()=>{
  const j = await fetch(`${API}?action=listSubjects`).then(r=>r.json()).catch(()=>({status:"err"}));
  if(j.status!=="success") return alert("โหลดวิชาไม่ได้");

  const box = document.getElementById("subjectBox");
  box.innerHTML = j.subjects.map(s=>
    `<button class="subj px-4 py-2 m-1 rounded-xl bg-white/80 hover:bg-white shadow"
             data-code="${s.code}">${s.name}</button>`).join("");

  document.querySelectorAll(".subj").forEach(b=>{
    b.onclick = ()=> loadParts(b.dataset.code,b.textContent);
  });
})();

/* ---------- 2. โหลด Part ของวิชาที่เลือก ---------- */
async function loadParts(subj,text){
  modal(`<p>กำลังโหลดบทเรียนของ <b>${text}</b> …</p>`);
  const j = await fetch(`${API}?action=listParts&subj=${subj}`).then(r=>r.json()).catch(()=>({status:"err"}));
  modal("");
  if(j.status!=="success"||!j.parts.length) return alert("ไม่พบข้อมูล");

  renderMap(j.parts);      // ➜ ไปสร้างแผนที่จาน
}

/* ---------- 3. เรนเดอร์ Map ---------- */
function renderMap(parts){
  const map = document.getElementById("map");
  map.innerHTML = "";                     // ล้างของเดิม

  /* 3-1  จัดกลุ่มตาม chapterId (= subject_id เช่น ST001) */
  const chapGroups = {};
  parts.forEach(p=>{
     (chapGroups[p.subject_id] = chapGroups[p.subject_id]||[]).push(p);
  });

  /* 3-2  สร้าง DOM */
  Object.entries(chapGroups).forEach(([chapId,list],idxChap)=>{
      // แถบหัวบท: ใช้ content ของแถวแรกเป็นชื่อบท
      const name = list[0].content.replace(/^\s*-/,"").trim();
      map.insertAdjacentHTML("beforeend",
        `<div class="chapter-bar"><span>บท ${idxChap+1}</span> • <span>${name}</span></div>`);

      // แถวจาน
      const row = document.createElement("div");
      row.className = "flex items-center flex-wrap";
      list.forEach(p=>{
         row.insertAdjacentHTML("beforeend",`
           <div class="part-wrap">
             <img src="${plateSrc}" class="plate-img" data-id="${p.part_no}" title="Part ${p.part_no}\n${p.content}">
             <span class="text-xs mt-1 max-w-[90px] truncate">${p.content}</span>
           </div>`);
      });
      map.appendChild(row);
  });

  /* 3-3  (Optional) bind click เข้า Part */
  map.querySelectorAll(".plate-img").forEach(img=>{
     img.onclick = ()=>{
        const part = img.dataset.id;
        alert("คุณกด Part "+part+" — (ยังไม่ทำหน้า quiz/lesson ในตัวอย่างนี้)");
        // location.href = `play.html?subj=${currentSubj}&part=${part}`;
     };
  });
}
</script>
</body>
</html>
