<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ─────────  UI เก่า (คงไว้) ───────── */
.no-scroll::-webkit-scrollbar{display:none}
.no-scroll{scrollbar-width:none;-ms-overflow-style:none}

/* ─────────  จาน & เส้นเชื่อม (ใหม่) ───────── */
.bf-plate{
  @apply flex flex-col items-center gap-1.5 cursor-pointer transition-transform;
}
.bf-plate:hover{transform:scale(1.08)}

/* วงจานใช้รูป png */
.plate-circle{
  width:4.5rem;height:4.5rem;flex-shrink:0;
  background:url("https://i.postimg.cc/9Q00g2DS/image.png") center/contain no-repeat;
  display:flex;align-items:center;justify-content:center;
  color:#2563eb;font-weight:700;font-size:1rem;
}

/* เส้นเชื่อม (แท่งสีฟ้าอ่อน) */
.vert-line{
  width:.35rem;background:#93c5fd;position:absolute;left:2.07rem; /* กึ่งกลางวงจาน */
}
</style>
</head>

<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen">

<!-- ───────────── Header ───────────── -->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food (BETA)</h1>
  <a href="home.html"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
     กลับหน้าหลัก
  </a>
</header>

<!-- ───────────── Dashboard ───────────── -->
<section class="max-w-3xl mx-auto mt-6 grid grid-cols-2 gap-4">
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">บทที่เรียน</p>
    <p id="stat-lesson" class="text-2xl font-bold text-blue-700">0</p>
  </div>
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">Quiz ที่ทำ</p>
    <p id="stat-quiz" class="text-2xl font-bold text-blue-700">0</p>
  </div>
</section>

<!-- ───────────── SUBJECT BAR ───────────── -->
<section class="bg-white/70 shadow-inner">
  <div id="subjBar" class="flex gap-4 overflow-x-auto no-scroll px-6 py-3"></div>
</section>

<!-- ───────────── COURSE MAP ───────────── -->
<main class="flex-1 overflow-auto p-6">
  <div id="mapZone" class="relative mx-auto w-max"></div>
</main>

<!-- Modal -->
<div id="modal-root"></div>

<script>
/* ---------- CONFIG ---------- */
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const SUBJ_NAMES = {
  ST:"วิทยาศาสตร์", ET:"ภาษาอังกฤษ", TH:"ภาษาไทย", MT:"คณิตศาสตร์",
  SO:"สังคมศึกษา", HE:"สุขศึกษา", PE:"พลศึกษา", HS:"ประวัติศาสตร์",
  CH:"ภาษาจีน", ME:"คณิตสากล", SE:"วิทย์สากล", EN:"ENS",
  SR:"เทคโนโลยี", SW:"วิทยาการคอมฯ", SD:"ออกแบบเว็บไซต์", AA:"การงานอาชีพ"
};

/* ---------- USER / MAX  (ของเดิม) ---------- */
const user  = JSON.parse(localStorage.getItem("user") || "null");
const isMAX = !!user?.lineId;

/* ---------- DASHBOARD (ของเดิม) ---------- */
(async()=>{
  if(!user) return;
  try{
    const j = await fetch(`${API}?action=get_brain_stats&no=${user.no}`).then(r=>r.json());
    if(j.status==="success"){
      const [l,q] = j.count.split(" ");
      document.getElementById("stat-lesson").textContent = l;
      document.getElementById("stat-quiz").textContent   = q;
    }
  }catch(e){ console.log("stats error",e); }
})();

/* ---------- SUBJECT BAR ---------- */
(async()=>{
  const bar = subjBar;
  try{
     const j = await fetch(`${API}?action=listSubjects`).then(r=>r.json());
     if(j.status!=="success") throw 0;

     bar.innerHTML = j.subjects.map(s=>{
        const name = s.name || SUBJ_NAMES[s.code] || s.code;
        return `<button data-code="${s.code}"
                 class="subj-btn whitespace-nowrap px-4 py-2 bg-blue-100 rounded-xl hover:bg-blue-200">
                 ${name}</button>`;
     }).join("");

     bar.querySelectorAll(".subj-btn").forEach(btn=>{
        btn.onclick = ()=>{
          bar.querySelectorAll(".subj-btn").forEach(b=>b.classList.remove("bg-blue-600","text-white"));
          btn.classList.add("bg-blue-600","text-white");
          loadMap(btn.dataset.code);
        };
     });
     bar.querySelector(".subj-btn")?.click();
  }catch{
     bar.innerHTML = "<p class='text-red-600'>โหลดวิชาไม่สำเร็จ</p>";
  }
})();

/* ---------- LOAD & DRAW MAP (แนวดิ่ง) ---------- */
async function loadMap(subj){
  const zone = mapZone;
  zone.innerHTML = "<p class='text-center text-blue-700'>กำลังโหลด…</p>";
  try{
    const j = await fetch(`${API}?action=listParts&subj=${subj}`).then(r=>r.json());
    if(j.status!=="success" || !j.chapters?.length) throw 0;

    /* แปลง rows = [{chap,part,content}] และเรียงตาม chap+part */
    const rows = [];
    j.chapters.sort((a,b)=>a.id.localeCompare(b.id)).forEach(ch=>{
       ch.parts.sort((a,b)=>a.no-b.no).forEach(p=>{
          rows.push({chap:ch.id,part:p.no,content:p.content.join(",")});
       });
    });
    drawVertical(rows, zone);
  }catch{
    zone.innerHTML = "<p class='text-center text-red-600'>โหลดข้อมูลบทไม่สำเร็จ</p>";
  }
}

function drawVertical(rows, zone){
  zone.innerHTML = "";
  const stepH = 150;                             // ระยะห่างแต่ละจาน
  /* เส้นแกนกลาง (แนวตั้ง) */
  zone.insertAdjacentHTML("afterbegin",
     `<div style="position:absolute;left:2.07rem;top:0;width:.35rem;
                  height:${rows.length*stepH - 60}px;
                  background:#bfdbfe;border-radius:.2rem"></div>`);

  rows.forEach((r,i)=>{
     const top = i*stepH;
     /* plate */
     zone.insertAdjacentHTML("beforeend",`
       <div class="bf-plate absolute" style="top:${top}px;left:0"
            onclick="goQuiz('${r.chap}',${r.part})">
         <div class="plate-circle">${r.part}</div>
         <span class="text-xs text-blue-900 max-w-[6rem] break-words text-center">${r.content}</span>
       </div>`);

     /* เส้นเชื่อมระหว่างจาน (ยาวถึงจานถัดไป) */
     if(i < rows.length-1){
       zone.insertAdjacentHTML("beforeend",`
         <div class="vert-line"
              style="top:${top+78}px;height:${stepH-96}px"></div>`);
     }
  });
  zone.style.height = `${rows.length*stepH}px`;
}

/* ---------- ไปหน้า Quiz ---------- */
function goQuiz(chap,part){
  location.href = `quiz.html?chap=${chap}&part=${part}`;
}

/* ---------- Modal helper (ของเดิม) ---------- */
const modalRoot = document.getElementById("modal-root");
function openModal(html){
  modalRoot.innerHTML =
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[90] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`;
  mask.onclick = e=>{if(e.target.id==="mask") closeModal();};
}
function closeModal(){ modalRoot.innerHTML = ""; }

/* ---------- (ยังคง) Snack / Full / Salad  ---------- */
/* …โค้ด Snack / Full / Salad ที่คุณมีเดิมยังคงทำงานได้เหมือนเดิม
   (อยู่ล่างสุดของไฟล์ตามที่คุณให้มา) … */
</script>
</body>
</html>
