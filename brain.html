<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
body{font-family:'Kanit',sans-serif}

/* ───────── Loader ───────── */
#loader{backdrop-filter:blur(4px)}
/* ───────── Slide-up number ───────── */
@keyframes slideUp{from{transform:translateY(30px);opacity:0}
                   to  {transform:translateY(0);opacity:1}}
/* ───────── Shine after load ───────── */
.shine-target{position:relative;overflow:hidden}
.shine-target::after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  background:linear-gradient(120deg,transparent 0,
            rgba(255,255,255,.6) 50%,transparent 100%);
  transform:translateX(-100%);
}
.shine-target.shine::after{animation:shimmer 1.2s forwards}
@keyframes shimmer{to{transform:translateX(100%)}}

/* ───────── กล่องลายการ์ตูน (PNG) ───────── */
.pattern-snack{
  background:url("https://i.postimg.cc/nzPWyPRc/zip-1.png") center/cover no-repeat;
}
.pattern-full{
  background:url("https://i.postimg.cc/Th84wWvz/zip-2.png") center/cover no-repeat;
}
.pattern-salad{
  background:url("https://i.postimg.cc/J0HFM5v3/zip-3.png") center/cover no-repeat;
}
/* overlay ให้อ่านตัวอักษรได้ */
.pattern-snack::after,.pattern-full::after,.pattern-salad::after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  background:rgba(255,255,255,.28);pointer-events:none;
}

/* ───────── confetti / pop (ของเดิม) ───────── */
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}
.pop{animation:pop .5s}
/* confetti */
@keyframes fall{to{transform:translateY(60px) rotate(720deg);opacity:0}}
.confetti{position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;animation:fall .7s ease-out forwards}

/* hide scrollbar */
#bf-scroll.no-scrollbar::-webkit-scrollbar{display:none}
#bf-scroll.no-scrollbar{scrollbar-width:none;-ms-overflow-style:none}
</style>
</head>

<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen">

<!-- ░░ Loader ░░ -->
<div id="loader" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-white/80">
  <div class="h-16 w-16 animate-spin rounded-full border-t-4 border-blue-500"></div>
</div>

<!-- ░░ Header ░░ -->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food (BETA)</h1>
  <a href="home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
    กลับหน้าหลัก
  </a>
</header>

<!-- ░░ Dashboard ░░ -->
<section class="max-w-3xl mx-auto mt-6 grid grid-cols-2 gap-4">
  <div class="bg-white/80 rounded-xl p-4 text-center shadow shine-target">
    <p class="text-gray-500">บทที่เรียน</p>
    <p id="stat-lesson" class="text-2xl font-bold text-blue-700 opacity-0">0</p>
  </div>
  <div class="bg-white/80 rounded-xl p-4 text-center shadow shine-target">
    <p class="text-gray-500">Quiz ที่ทำ</p>
    <p id="stat-quiz" class="text-2xl font-bold text-blue-700 opacity-0">0</p>
  </div>
</section>

<!-- ░░ Brain-Food Pass ░░ -->
<section class="max-w-5xl mx-auto mt-10 px-6">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-bold text-blue-800 text-lg">Brain-Food Pass</h2>
    <p class="text-sm text-gray-600">แต้มของคุณ: <span id="bf-point" class="font-bold">0</span></p>
  </div>

  <div class="relative">
    <button id="bf-left"
            class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/70 hover:bg-white shadow p-1 rounded-full">‹</button>
    <button id="bf-right"
            class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/70 hover:bg-white shadow p-1 rounded-full">›</button>

    <div id="bf-scroll" class="overflow-x-auto no-scrollbar scroll-smooth px-8">
      <div id="bf-track" class="relative flex gap-14 items-center py-4 w-max">
        <!-- เส้นกลางเติมด้วย JS -->
      </div>
    </div>
  </div>
</section>

<!-- ░░ Set Boxes ░░ -->
<section class="max-w-4xl mx-auto mt-10 grid md:grid-cols-3 gap-6 px-4">

  <!-- Snack -->
  <div id="box-snack" class="group cursor-pointer shine-target relative">
    <div class="pattern-snack rounded-2xl h-40 flex items-center justify-center shadow-lg
                group-hover:scale-105 transition relative overflow-hidden">
      <span class="relative z-10 text-white drop-shadow font-bold text-xl">Snack&nbsp;Set</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">สรุปสั้น + Quiz 5 ข้อ</p>
  </div>

  <!-- Full -->
  <div id="box-full" class="group cursor-pointer shine-target relative">
    <div class="pattern-full rounded-2xl h-40 flex items-center justify-center shadow-lg
                group-hover:scale-105 transition relative overflow-hidden">
      <span class="relative z-10 text-white drop-shadow font-bold text-xl">Full&nbsp;Meal</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">บทเรียนเต็ม + Quiz 15 ข้อ (เฉพาะ MAX)</p>
    <div id="lock-full"
         class="absolute inset-0 rounded-2xl bg-white/80 backdrop-blur flex items-center justify-center
                text-purple-700 font-semibold hidden">เฉพาะ MAX</div>
  </div>

  <!-- Salad -->
  <div id="box-salad" class="group cursor-pointer shine-target relative">
    <div class="pattern-salad rounded-2xl h-40 flex items-center justify-center shadow-lg
                group-hover:scale-105 transition relative overflow-hidden">
      <span class="relative z-10 text-white drop-shadow font-bold text-xl">Salad&nbsp;Set</span>
    </div>
    <p class="mt-2 text-center text-sm text-gray-700">Quiz รวมทุกบท 20 ข้อ</p>
    <div id="lock-salad"
         class="absolute inset-0 rounded-2xl bg-white/80 backdrop-blur flex items-center justify-center
                text-cyan-700 font-semibold hidden">เฉพาะ MAX</div>
  </div>
</section>

<!-- Modal root -->
<div id="modal-root"></div>

<script>
/* === CONFIG / USER ================================================= */
const API  = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const user = JSON.parse(localStorage.getItem("user")||"null");
if(!user){alert("กรุณาเข้าสู่ระบบ");location.href="index.html";}
const isMAX = !!user.lineId;

/* === Loader helpers =============================================== */
const loader=document.getElementById('loader');
let loadCnt=0;
const showLoader=()=>{if(++loadCnt===1)loader.classList.remove('hidden');};
const hideLoader=()=>{if(--loadCnt<=0){loadCnt=0;loader.classList.add('hidden');shineBoxes();}};
function shineBoxes(){document.querySelectorAll('.shine-target').forEach(el=>{
  el.classList.add('shine');setTimeout(()=>el.classList.remove('shine'),1200);
});}

/* === Dashboard ===================================================== */
(async()=>{
  try{
    showLoader();
    const j=await fetch(`${API}?action=get_brain_stats&no=${user.no}`).then(r=>r.json());
    if(j.status==="success"){
      const [lesson,quiz]=j.count.split(" ");
      const lEl=document.getElementById('stat-lesson');
      const qEl=document.getElementById('stat-quiz');
      lEl.textContent=lesson;qEl.textContent=quiz;
      lEl.style.animation="slideUp .9s ease-out forwards";
      qEl.style.animation="slideUp .9s ease-out forwards";
    }
  }catch(e){console.warn(e);}
  finally{hideLoader();}
})();

/* === Modal helpers ================================================ */
function openModal(html){
  document.getElementById("modal-root").innerHTML=
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[80] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`;
  document.getElementById("mask").onclick=e=>{if(e.target.id==="mask")closeModal();};
}
function closeModal(){document.getElementById("modal-root").innerHTML="";}

/* === Choose Subject / Chapter ===================================== */
async function listSubjects(mode){
  try{
    showLoader();
    const j=await fetch(`${API}?action=list_snack_subjects`).then(r=>r.json());
    if(j.status!=="success")return alert("โหลดวิชาไม่ได้");
    const html=j.subjects.map(s=>`
      <button class="${mode==='snack'?'bg-blue-100 hover:bg-blue-200':'bg-indigo-100 hover:bg-indigo-200'}
                      sub-btn px-4 py-2 rounded-xl m-1" data-subj="${s.code}">
         ${s.name}
      </button>`).join("");
    openModal(`<h3 class="text-lg font-semibold ${mode==='snack'?'text-blue-800':'text-indigo-800'} mb-3">
                 เลือกวิชา (${mode==='snack'?'Snack':'Full'} Set)
               </h3>${html}`);
    document.querySelectorAll(".sub-btn").forEach(b=>{
      b.onclick=()=>chooseChapter(b.dataset.subj,mode);
    });
  }finally{hideLoader();}
}
async function chooseChapter(subj,mode){
  try{
    showLoader();
    const j=await fetch(`${API}?action=list_snack_chapters&subj=${subj}`).then(r=>r.json());
    if(j.status!=="success")return alert("error");
    const html=j.chapters.map(c=>`
      <button class="chap-btn block w-full text-left px-4 py-2 my-1 rounded-xl
                     ${mode==='snack'?'bg-gray-100 hover:bg-gray-200':'bg-purple-100 hover:bg-purple-200'}"
              data-id="${c.id}">${c.title}</button>`).join("");
    openModal(`<h3 class="text-lg font-semibold ${mode==='snack'?'text-blue-800':'text-purple-800'} mb-3">
                 เลือกบท – ${subj}</h3>${html}`);
    document.querySelectorAll(".chap-btn").forEach(b=>{
      const id=b.dataset.id;
      b.onclick=()=>location.href=`${mode==='snack'?'lesson':'full'}.html?id=${id}`;
    });
  }finally{hideLoader();}
}

/* === Box handlers ================================================= */
document.getElementById("box-snack").onclick = () => listSubjects('snack');
document.getElementById("box-full").onclick  = () =>{
  if(!isMAX){alert("ฟีเจอร์นี้สงวนสำหรับ MAX");return;}
  listSubjects('full');
};
document.getElementById("box-salad").onclick = ()=>location.href="salad.html";

/* === Brain-Food Pass ============================================== */
const bfPointEl=document.getElementById('bf-point');
const bfTrack=document.getElementById('bf-track');
const bfScroll=document.getElementById('bf-scroll');
document.getElementById('bf-left').onclick=()=>bfScroll.scrollBy({left:-300,behavior:'smooth'});
document.getElementById('bf-right').onclick=()=>bfScroll.scrollBy({left:300,behavior:'smooth'});

function animatePop(id){
  const img=bfTrack.querySelector(`img[data-id="${id}"]`);if(!img)return;
  img.classList.add('pop');setTimeout(()=>img.classList.remove('pop'),500);
  const rect=img.getBoundingClientRect();
  for(let i=0;i<24;i++){
    const c=document.createElement('div');
    c.className='confetti';
    c.style.left=rect.left+rect.width/2+(Math.random()*40-20)+'px';
    c.style.top =rect.top+'px';
    c.style.background=`hsl(${Math.random()*360} 80% 60%)`;
    document.body.appendChild(c);setTimeout(()=>c.remove(),700);
  }
}
function renderPass(rewards,point){
  let html=`<div class="absolute inset-x-0 top-1/2 -translate-y-1/2 h-1 bg-gray-300 rounded-full -z-10"></div>`;
  rewards.sort((a,b)=>a.need-b.need).forEach(r=>{
    let state=r.status;if(state==="locked"&&point>=r.need)state="claim";
    const imgCls=state==="used"?"opacity-30":state==="claim"?"animate-pulse":"";
    const btn=state==="used"
        ?`<span class="bg-gray-300 text-xs px-3 py-0.5 rounded text-white">ใช้แล้ว</span>`
        :state==="claimed"
        ?`<button class="btn-use bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-0.5 rounded" data-id="${r.id}">ใช้</button>`
        :state==="claim"
        ?`<button class="btn-claim bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-0.5 rounded" data-id="${r.id}">แลก</button>`
        :`<span class="bg-gray-300 text-xs px-3 py-0.5 rounded text-white cursor-not-allowed">รอแต้ม</span>`;
    html+=`
      <div class="flex flex-col items-center gap-1 min-w-[80px]">
        <img src="${r.img}" data-id="${r.id}"
             class="w-16 h-16 rounded-full border-2 border-white shadow ${imgCls}">
        <p class="text-xs text-center">${r.need} แต้ม</p>
        ${btn}
      </div>`;
  });
  bfTrack.innerHTML=html;

  bfTrack.querySelectorAll('.btn-claim').forEach(b=>{
    b.onclick=async()=>{if(!confirm("ยืนยันรับรางวัลนี้?"))return;
      const id=b.dataset.id;b.disabled=true;showLoader();
      try{
        const j=await fetch(`${API}?action=claim_reward&no=${user.no}&id=${id}`).then(r=>r.json());
        if(j.status==="success"){animatePop(id);await loadPass();}
        else alert("รับรางวัลไม่สำเร็จ");
      }finally{hideLoader();}
    };
  });
  bfTrack.querySelectorAll('.btn-use').forEach(b=>{
    b.onclick=async()=>{if(!confirm("ใช้รางวัลนี้ตอนนี้หรือไม่?"))return;
      const id=b.dataset.id;b.disabled=true;showLoader();
      try{
        const j=await fetch(`${API}?action=use_reward&no=${user.no}&id=${id}`).then(r=>r.json());
        if(j.status==="success"){animatePop(id);await loadPass();}
        else alert("ใช้รางวัลไม่สำเร็จ");
      }finally{hideLoader();}
    };
  });
}
async function loadPass(){
  try{
    showLoader();
    const j=await fetch(`${API}?action=list_rewards&no=${user.no}`).then(r=>r.json());
    if(j.status==="success"){
      bfPointEl.textContent=j.point;
      renderPass(j.rewards,j.point);
    }
  }catch(e){console.error(e);}
  finally{hideLoader();}
}
loadPass();
</script>
</body>
</html>
