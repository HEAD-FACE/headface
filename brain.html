<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Brain Food – HEAD FACE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style type="text/tailwindcss">
  /*​— scrollbar & แผ่นจาน —*/
  .no-scroll::-webkit-scrollbar{display:none}@media{.no-scroll{scrollbar-width:none;-ms-overflow-style:none}}
  .plate-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:.4rem;cursor:pointer;transition:.2s}
  .plate-wrap:hover{transform:scale(1.06)}
  .plate-img{width:86px;height:86px;background:url("https://i.postimg.cc/9Q00g2DS/image.png") center/cover no-repeat;
             display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3)}
  .plate-line{position:absolute;left:50%;top:86px;width:2px;height:38px;background:#93c5fd;transform:translateX(-50%)}
  .chapter-bar{width:100%;background:#bfdbfe;color:#1e3a8a;font-weight:700;padding:6px 10px;margin:32px 0 20px;border-radius:12px;
               display:flex;gap:10px;align-items:center}
  .chapter-bar span{background:#1e40af;color:#fff;font-size:.85rem;padding:2px 8px;border-radius:9999px}
</style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen flex flex-col">

<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food</h1>
  <a href="home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">กลับหน้าหลัก</a>
</header>

<section class="bg-white/70 shadow-inner">
  <div id="subjBar" class="flex gap-4 overflow-x-auto no-scroll px-6 py-3"></div>
</section>

<main class="flex-1 overflow-auto p-6">
  <div id="mapZone" class="relative mx-auto max-w-xl"></div>
</main>

<div id="modal-root"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const user = JSON.parse(localStorage.getItem("user")||"null");
const doneImgs=[
  "https://i.postimg.cc/T3mRy3Fr/zip-2.png",
  "https://i.postimg.cc/5tSb3kxy/zip-3.png",
  "https://i.postimg.cc/LX4R0BXT/zip-4.png",
  "https://i.postimg.cc/0QtxgMKq/zip-5.png",
  "https://i.postimg.cc/d0YJGKcg/zip-6.png",
  "https://i.postimg.cc/D08h7v14/zip-7.png"
];
const SUBJ_NAMES={ST:"วิทยาศาสตร์",ET:"อังกฤษ",TH:"ไทย",MT:"คณิต",SO:"สังคม",HE:"สุขศ.",PE:"พละ",
                  HS:"ประวัติ",CH:"จีน",ME:"Math En",SE:"Sci En",EN:"ENS",SR:"เทคโนฯ",SW:"คอม",SD:"เว็บ",AA:"การงาน"};

loadSubjects();

/* ---------- subject bar ---------- */
async function loadSubjects(){
  const bar=document.getElementById("subjBar");
  try{
    const j=await fetch(`${API}?action=listSubjects`).then(r=>r.json());
    if(j.status!=="success") throw 0;
    bar.innerHTML=j.subjects.map(s=>{
      const name=s.name||SUBJ_NAMES[s.code]||s.code;
      return `<button class="subj-btn whitespace-nowrap px-4 py-2 bg-blue-100 rounded-xl hover:bg-blue-200"
                      data-code="${s.code}">${name}</button>`;
    }).join("");
    bar.querySelectorAll(".subj-btn").forEach(btn=>{
      btn.onclick=()=>{
        bar.querySelectorAll(".subj-btn").forEach(b=>b.classList.remove("bg-blue-600","text-white"));
        btn.classList.add("bg-blue-600","text-white");
        loadMap(btn.dataset.code);
      };
    });
    bar.querySelector(".subj-btn")?.click();
  }catch{bar.innerHTML="<p class='text-red-600'>โหลดวิชาไม่สำเร็จ</p>";}
}

/* ---------- map ---------- */
async function loadMap(subj){
  const zone=document.getElementById("mapZone");
  zone.innerHTML="<p class='text-center text-blue-700'>กำลังโหลด…</p>";
  try{
    const j=await fetch(`${API}?action=listPartsStatus&subj=${subj}&no=${user?.no||""}`).then(r=>r.json());
    if(j.status!=="success"||!j.chapters?.length) throw 0;
    draw(j.chapters,subj,zone);
  }catch{zone.innerHTML="<p class='text-center text-red-600'>โหลดข้อมูลไม่สำเร็จ</p>";}
}

function draw(chapters,subj,zone){
  zone.innerHTML="";
  /* วาดตามบท */
  chapters.sort((a,b)=>a.id.localeCompare(b.id)).forEach(ch=>{
    const parts=[...ch.parts].sort((a,b)=>a.no-b.no);

    // bar ชื่อบท
    const barTitle=parts[0].content[0]||`บทที่ ${ch.id.replace(/\D+/g,"")}`;
    zone.insertAdjacentHTML("beforeend",
      `<div class="chapter-bar"><span>${ch.id}</span>${barTitle}</div>`);

    // plates
    parts.forEach((p,idx)=>{
      const done=!!p.done;
      const img= done ? doneImgs[Math.floor(Math.random()*doneImgs.length)] : "https://i.postimg.cc/9Q00g2DS/image.png";
      const next = idx<parts.length-1 ?
           '<div class="plate-line"></div>' : '';

      zone.insertAdjacentHTML("beforeend",`
        <div class="plate-wrap" data-chap="${ch.id}" data-part="${p.no}" data-subj="${subj}">
          <div class="plate-img" style="background-image:url('${img}')">${p.no}</div>
          ${next}
        </div>`);
    });
  });

  /* event click plate */
  zone.querySelectorAll(".plate-wrap").forEach(div=>{
     div.onclick=()=>{
        const subj=div.dataset.subj;
        const chap=div.dataset.chap;
        const part=div.dataset.part;
        location.href=`quiz.html?subj=${subj}&chap=${chap}&part=${part}`;
     };
  });
}

/* ---------- modal helper เดิม ---------- */
function openModal(html){
  document.getElementById("modal-root").innerHTML=
   `<div id="mask" class="fixed inset-0 bg-black/40 z-[90] flex items-center justify-center">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`;
  document.getElementById("mask").onclick=e=>{if(e.target.id==="mask")closeModal();};
}
function closeModal(){document.getElementById("modal-root").innerHTML="";}
</script>
</body>
</html>
