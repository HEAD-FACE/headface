<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Brain Food – HEAD FACE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* scroll bar */
    .no-scroll::-webkit-scrollbar{display:none}
    .no-scroll{scrollbar-width:none;-ms-overflow-style:none}

    /* plate = จาน */
    .bf-plate{display:flex;flex-direction:column;align-items:center;gap:.35rem;cursor:pointer;transition:transform .2s}
    .bf-plate:hover{transform:scale(1.08)}
    .plate-circle{width:4.5rem;height:4.5rem;border-radius:9999px;
                  display:flex;align-items:center;justify-content:center;
                  background:linear-gradient(135deg,#38bdf8 0%,#2563eb 100%);
                  color:#fff;font-size:.78rem;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.15)}
    /* line */
    .bf-line-v{position:absolute;width:2px;background:#93c5fd;left:50%;transform:translateX(-50%)}
    .bf-line-h{position:absolute;height:2px;background:#93c5fd;top:50%;transform:translateY(-50%)}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen flex flex-col">

<!---------------- Header ---------------->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-xl font-bold text-blue-700">Brain Food</h1>
  <a href="home.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-xl font-semibold">
    กลับหน้าหลัก
  </a>
</header>

<!---------------- DASHBOARD (เดิม) ---------------->
<section class="max-w-3xl mx-auto mt-6 grid grid-cols-2 gap-4">
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">บทที่เรียน</p>
    <p id="stat-lesson" class="text-2xl font-bold text-blue-700">0</p>
  </div>
  <div class="bg-white/80 rounded-xl p-4 text-center shadow">
    <p class="text-gray-500">Quiz ที่ทำ</p>
    <p id="stat-quiz" class="text-2xl font-bold text-blue-700">0</p>
  </div>
</section>

<!---------------- SUBJECT BAR ---------------->
<section class="bg-white/70 shadow-inner">
  <div id="subjBar" class="flex gap-4 overflow-x-auto no-scroll px-6 py-3"></div>
</section>

<!---------------- COURSE MAP ---------------->
<main class="flex-1 overflow-auto p-6">
  <div id="mapZone" class="relative mx-auto max-w-xl"></div>
</main>

<!-- modal (ยังไม่ใช้) -->
<div id="modal-root"></div>

<!---------------- Script ---------------->
<script>
/* ---------- CONFIG ---------- */
const API = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";

/* ชื่อวิชาสำรอง */
const SUBJ_NAMES = {
  ST:"วิทยาศาสตร์", ET:"ภาษาอังกฤษ", TH:"ภาษาไทย", MT:"คณิตศาสตร์",
  SO:"สังคมศึกษา", HE:"สุขศึกษา", PE:"พลศึกษา", HS:"ประวัติศาสตร์",
  CH:"ภาษาจีน", ME:"คณิตสากล", SE:"วิทย์สากล", EN:"ENS",
  SR:"เทคโนโลยี", SW:"วิทยาการคอมฯ", SD:"ออกแบบเว็บไซต์", AA:"การงานอาชีพ"
};

/* ---------- DASHBOARD ---------- */
(async()=>{
  const user = JSON.parse(localStorage.getItem("user")||"null");
  if(!user) return;
  try{
    const j = await fetch(`${API}?action=get_brain_stats&no=${user.no}`).then(r=>r.json());
    if(j.status==="success"){
      const [l,q] = j.count.split(" ");
      statLesson.textContent=l; statQuiz.textContent=q;
    }
  }catch{}
})();

/* ---------- SUBJECT BAR ---------- */
(async()=>{
  const bar = subjBar;
  try{
     const j = await fetch(`${API}?action=listSubjects`).then(r=>r.json());
     if(j.status!=="success") throw 0;
     bar.innerHTML = j.subjects.map(s=>{
        const name = s.name || SUBJ_NAMES[s.code] || s.code;
        return `<button data-code="${s.code}"
                class="subj-btn whitespace-nowrap px-4 py-2 bg-blue-100 rounded-xl hover:bg-blue-200">
                ${name}</button>`;
     }).join("");
     bar.querySelectorAll(".subj-btn").forEach(btn=>{
        btn.onclick = ()=>{
           bar.querySelectorAll(".subj-btn").forEach(b=>b.classList.remove("bg-blue-600","text-white"));
           btn.classList.add("bg-blue-600","text-white");
           loadMap(btn.dataset.code);
        };
     });
     bar.querySelector(".subj-btn")?.click();           // auto first
  }catch{
     bar.innerHTML="<p class='text-red-600'>โหลดวิชาไม่สำเร็จ</p>";
  }
})();

/* ---------- LOAD & DRAW MAP ---------- */
async function loadMap(subj){
  const zone = mapZone;
  zone.innerHTML="<p class='text-center text-blue-700'>กำลังโหลด…</p>";
  try{
    /* ดึงทุกบทของวิชานั้น */
    const j = await fetch(`${API}?action=listParts&subj=${subj}`).then(r=>r.json());
    if(j.status!=="success"||!j.chapters?.length) throw 0;

    /* แปลง rows = [{chap,part,content}] */
    const rows=[];
    j.chapters.forEach(ch=>{
        ch.parts.forEach(p=> rows.push({chap:ch.id,part:p.no,content:p.content.join(",")}));
    });

    drawMap(rows,zone);
  }catch{
    zone.innerHTML="<p class='text-center text-red-600'>โหลดข้อมูลบทไม่สำเร็จ</p>";
  }
}

/* ------ วาดแผนที่แบบ “จาน” พร้อมเส้น ------ */
function drawMap(rows, zone){
  zone.innerHTML="";
  const byChap={};
  rows.forEach(r=>{
     if(!byChap[r.chap]) byChap[r.chap]=[];
     byChap[r.chap].push(r);
  });
  const chaps=Object.keys(byChap).sort();           // ST001 ST002 …

  const rowH = 160, colW = 170;
  chaps.forEach((cid,rowIdx)=>{
     const parts = byChap[cid].sort((a,b)=>a.part-b.part);
     parts.forEach((p,colIdx)=>{
        const top = rowIdx*rowH, left = colIdx*colW;

        /* node */
        zone.insertAdjacentHTML("beforeend",`
          <div class="bf-plate absolute" style="top:${top}px;left:${left}px"
               onclick="goQuiz('${cid}',${p.part})">
            <div class="plate-circle">${p.part}</div>
            <span class="text-xs text-blue-900">${p.content}</span>
          </div>`);

        /* เส้นแนวนอนเชื่อมไปจานถัดไป */
        if(colIdx < parts.length-1){
          zone.insertAdjacentHTML("beforeend",`
            <div class="bf-line-h" style="
                 left:${left+colW/2 +72}px; width:${colW-72}px; top:${top+36}px"></div>`);
        }

        /* เส้นแนวตั้งเชื่อมลงบทถัดไป (แค่วางใต้คอลัมน์แรก) */
        if(colIdx===0 && rowIdx<chaps.length-1){
          zone.insertAdjacentHTML("beforeend",`
            <div class="bf-line-v" style="top:${top+90}px; height:${rowH-20}px;
                 left:${left+colW/2}px"></div>`);
        }
     });
  });
  zone.style.height = `${chaps.length*rowH + 40}px`;
}

/* ไปหน้า quiz */
function goQuiz(chap,part){
  location.href=`quiz.html?chap=${chap}&part=${part}`;
}

/* ---------- Modal helper (เดิม) ---------- */
function openModal(html){
  modalRoot.innerHTML =
    `<div id="mask" class="fixed inset-0 bg-black/40 z-[90] flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">${html}</div></div>`;
  mask.onclick=e=>{if(e.target.id==="mask") closeModal();}
}
function closeModal(){ modalRoot.innerHTML=""; }
</script>
</body>
</html>
