<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Salad Set ‚Äì HEAD FACE</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-teal-100 to-cyan-200 min-h-screen flex flex-col">

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<header class="bg-white shadow-md py-3 px-6 flex justify-between items-center">
  <h1 class="text-lg md:text-xl font-bold text-cyan-700">Salad Set ‚Äì Quiz ‡∏ú‡∏™‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏ó</h1>
  <a href="brain.html"
     class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1 rounded-xl font-semibold">
     ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Brain Food
  </a>
</header>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 1 : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="stepSubject" class="flex-1 flex flex-col items-center justify-center p-6">
  <h2 class="text-xl font-bold mb-4 text-cyan-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</h2>
  <div id="subjBox" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 2 : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó (‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏ó) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="stepChapter" class="hidden flex-1 flex-col items-center justify-center p-6">
  <h2 id="subjTitle" class="text-xl font-bold mb-4 text-cyan-800"></h2>

  <form id="chapForm"
        class="max-h-80 w-full max-w-md overflow-y-auto p-3 border rounded bg-white/70"></form>

  <button id="startQuiz"
          class="mt-5 bg-cyan-600 hover:bg-cyan-700 text-white px-8 py-2 rounded-xl disabled:opacity-40"
          disabled>
    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ Quiz 20 ‡∏Ç‡πâ‡∏≠
  </button>
</section>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MODAL ROOT (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="modal-root"></div>

<script>
/* ---------------- CONFIG ---------------- */
const API   = "https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec";
const user  = JSON.parse(localStorage.getItem("user")||"null");
if(!user){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"); location.href="index.html"; }

/* ------------ MODAL helper ------------- */
function openModal(html){
  document.getElementById("modal-root").innerHTML =
    `<div id="mask" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
       <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center">${html}</div>
     </div>`;
  document.getElementById("mask").onclick = e=>{
     if(e.target.id==="mask") closeModal();
  };
}
function closeModal(){ document.getElementById("modal-root").innerHTML=""; }

/* ---------------- STEP 1 : ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ ---------------- */
(async()=>{
  const j = await fetch(`${API}?action=list_snack_subjects`).then(r=>r.json());
  if(j.status!=="success"){ alert("‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); return; }

  document.getElementById("subjBox").innerHTML =
    j.subjects.map(s=>`
      <button data-code="${s.code}" data-name="${s.name}"
              class="subj w-full px-4 py-6 bg-white/70 hover:bg-white rounded-xl shadow
                     text-cyan-700 font-semibold">
        ${s.name}
      </button>`).join("");

  document.querySelectorAll(".subj").forEach(btn=>{
     btn.onclick = () => loadChapters(btn.dataset.code,btn.dataset.name);
  });
})();

/* ---------------- STEP 2 : ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ó ---------------- */
async function loadChapters(subjCode, subjName){
  document.getElementById("stepSubject").classList.add("hidden");
  document.getElementById("stepChapter").classList.remove("hidden");
  document.getElementById("subjTitle").textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤ ${subjName}`;

  const j = await fetch(`${API}?action=list_salad_chapters&subj=${subjCode}`).then(r=>r.json());
  if(j.status!=="success"){ alert("error"); location.reload(); return; }

  const form = document.getElementById("chapForm");
  form.innerHTML = j.chapters.map(c=>`
       <label class="flex items-start gap-2 mb-2">
          <input type="checkbox" name="chap" value="${c.id}" class="accent-cyan-600 mt-1">
          <span>${c.title}</span>
       </label>`).join("");

  form.onchange = ()=>{
     const any = form.querySelectorAll("input:checked").length>0;
     document.getElementById("startQuiz").disabled = !any;
  };

  /* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° */
  window.__saladSubj = subjCode;
}

/* ------------ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥ Quiz‚Äù ------------ */
document.getElementById("startQuiz").onclick = async ()=>{
  const sel = [...document.querySelectorAll('#chapForm input:checked')].map(i=>i.value).join(",");

  /* ---------- LIMIT ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Free ---------- */
  const res = await fetch(`${API}?action=check_salad_limit&no=${user.no}&subj=${__saladSubj}`).then(r=>r.json());
  if(res.status==="limit"){
     openModal(`<h2 class="text-xl font-bold text-cyan-700 mb-3">‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h2>
                <p>‡∏•‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòâ</p>`);
     return;
  }

  /* ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Quiz */
  location.href = `quiz.html?mode=salad&subj=${__saladSubj}&id=${sel}`;
};
</script>
</body>
</html>
