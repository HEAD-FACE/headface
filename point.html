<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏° | Brain-Food</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Kanit',sans-serif}
    .confetti{position:absolute;width:6px;height:6px;border-radius:50%;pointer-events:none;
              animation:fall .7s ease-out forwards}
    @keyframes fall{to{transform:translateY(60px) rotate(720deg);opacity:0}}
  </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4">

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Loading Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur flex items-center justify-center z-50 hidden">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="w-full max-w-xl bg-white rounded-2xl shadow-xl p-6 space-y-6">

  <h1 class="text-center text-2xl font-bold text-indigo-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (BETA 2)</h1>

  <div id="user-info" class="grid grid-cols-2 gap-4 text-[1.05rem]"></div>

  <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
  <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-3xl text-white py-8 text-center shadow-lg">
    <div id="user-points" class="text-4xl font-extrabold tracking-widest">0</div>
    <p class="text-sm opacity-80 mt-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</p>
  </div>

  <button onclick="location.href='reward.html'"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-semibold shadow">
    üéÅ ‡∏î‡∏π‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
  </button>

  <div id="reward-list" class="space-y-4 max-h-[55vh] overflow-y-auto pr-1"></div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const API = 'https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec';

/* ---------------- Loader ---------------- */
const loadingEl = document.getElementById('loading');
const showLoading = ()=>loadingEl.classList.remove('hidden');
const hideLoading = ()=>loadingEl.classList.add('hidden');

/* ---------------- Utils ---------------- */
function animateNumber(el,start,end,dur=1000){
  if(start===end){ el.textContent=end; return; }
  const startT = performance.now();
  const step = now=>{
    const p = Math.min((now-startT)/dur,1);
    const val = Math.floor(start + (end-start)*p);
    el.textContent = val.toLocaleString();
    if(p<1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

/* ---------------- Load user ---------------- */
function fillUser(u){
  const wrap = document.getElementById('user-info');
  wrap.innerHTML = `
    <div class="bg-indigo-50 rounded-xl p-3 shadow-inner">‡∏ä‡∏∑‡πà‡∏≠: ${u.firstName||'-'}</div>
    <div class="bg-indigo-50 rounded-xl p-3 shadow-inner">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: ${u.lastName||'-'}</div>
    <div class="bg-indigo-50 rounded-xl p-3 shadow-inner">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${u.no||'-'}</div>
    <div class="bg-indigo-50 rounded-xl p-3 shadow-inner">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${u.studentId||'-'}</div>`;
}

/* ---------------- Rewards ---------------- */
function renderRewards(rewards,point,uNo){
  const list = document.getElementById('reward-list');
  list.innerHTML='';
  rewards.forEach(r=>{
     const locked   = point < r.need;
     const claimed  = r.status==="claimed";
     const used     = r.status==="used";

     const btnTxt   = locked ? `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${r.need}` :
                      claimed? '‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' :
                      used   ? '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';

     const btnCls   = locked ? 'bg-gray-300 cursor-not-allowed' :
                      claimed? 'bg-orange-500 hover:bg-orange-600' :
                      used   ? 'bg-gray-400 cursor-not-allowed' :
                               'bg-green-600 hover:bg-green-700';

     const btnDis   = locked || used;

     const card = document.createElement('div');
     card.className = 'bg-indigo-50 rounded-2xl p-4 shadow flex gap-4';
     card.innerHTML = `
        <img src="${r.img}" class="w-16 h-16 rounded-full object-cover shrink-0">
        <div class="flex-1">
          <h3 class="font-semibold text-indigo-700">${r.title}</h3>
          <p class="text-sm text-gray-600 mt-1">${r.desc}</p>
          <p class="text-sm text-gray-500 mt-1">‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: ${r.need} ‡πÅ‡∏ï‡πâ‡∏°</p>
          <button class="${btnCls} mt-3 text-white px-4 py-1 rounded btn"
                  ${btnDis?'disabled':''} data-id="${r.id}" data-state="${r.status}">
             ${btnTxt}
          </button>
        </div>`;
     list.appendChild(card);
  });

  /* ---- event ---- */
  list.querySelectorAll('.btn:not([disabled])').forEach(btn=>{
     btn.onclick = async ()=>{
        const id    = btn.dataset.id;
        const state = btn.dataset.state;
        const act   = state==="claimed" ? "use" : "claim";
        const conf  = act==="use" ? "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?" : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ?";

        if(!confirm(conf)) return;
        showLoading();
        try{
          const url = `${API}?action=${act}_reward&no=${user.no}&id=${id}`;
          const j   = await fetch(url).then(r=>r.json());
          if(j.status==="success"){
             // confetti pop
             const rect = btn.getBoundingClientRect();
             for(let i=0;i<25;i++){
               const c = document.createElement('div');
               c.className='confetti';
               c.style.background=`hsl(${Math.random()*360},80%,60%)`;
               c.style.left = rect.left + rect.width/2 + (Math.random()*50-25)+'px';
               c.style.top  = rect.top + 'px';
               document.body.appendChild(c);
               setTimeout(()=>c.remove(),700);
             }
             await init();                 // reload data
           }else alert(j.message||"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }catch(e){ alert("network error"); }
        hideLoading();
     };
  });
}

/* ---------------- Init (load point + reward) ---------------- */
async function init(){
  showLoading();
  try{
    const j = await fetch(`${API}?action=list_rewards&no=${user.no}`).then(r=>r.json());
    if(j.status!=="success") throw "error";
    animateNumber(document.getElementById('user-points'),
                  Number(document.getElementById('user-points').textContent.replace(/,/g,'')),
                  j.point,800);
    renderRewards(j.rewards,j.point,user.no);
  }catch(e){ alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); console.log(e); }
  hideLoading();
}

/* ---------------- main load ---------------- */
window.addEventListener('DOMContentLoaded',()=>{
  const u = JSON.parse(localStorage.getItem('user')||"null");
  if(!u){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"); location.href='index.html'; return; }
  window.user = u;
  fillUser(u);
  init();
});
</script>
</body>
</html>
